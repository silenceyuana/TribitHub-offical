<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Wiki 文章编辑器 - TribitHub 后台</title>
    <link rel="stylesheet" href="/dist/css/style.css">
    <link rel="icon" href="dist/images/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <style>
        body { background-color: var(--bg-color); }
        .editor-container { max-width: 900px; margin: 2rem auto; padding: 2rem; background-color: var(--card-bg); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .page-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 2rem; }
        .status-message { margin-top: 1rem; font-weight: 500; }
        .CodeMirror { border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-input); color: var(--text-primary); }
        .editor-toolbar { border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .category-field-wrapper { display: flex; align-items: flex-end; gap: 0.5rem; }
        .category-field-wrapper .field { flex-grow: 1; margin-bottom: 0; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-dialog { width: auto; margin: 0.5rem; }
        @media (min-width: 576px) { .modal-dialog { max-width: 500px; margin: 1.75rem auto; } }
        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .modal-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 1rem 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-title { margin: 0; line-height: 1.5; color: var(--text-primary); }
        .modal-body { position: relative; flex: 1 1 auto; padding: 1rem; }
        .modal-footer { display: flex; align-items: center; justify-content: flex-end; padding: 1rem; border-top: 1px solid var(--border-color); gap: 0.5rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0; }
    </style>
</head>
<body class="is-boxed">
    <div class="editor-container">
        <div class="page-header">
            <h1 class="h3" id="page-title">创建新文章</h1>
            <a href="/admin.html#wiki" class="button button-sm">返回列表</a>
        </div>

        <form id="articleForm">
            <div class="field">
                <label for="title" class="field-label">文章标题</label>
                <input type="text" id="title" name="title" class="input" required>
            </div>
            <div class="field">
                <label for="slug" class="field-label">URL Slug (用于链接)</label>
                <input type="text" id="slug" name="slug" class="input" required placeholder="例如: getting-started">
            </div>

            <div class="category-field-wrapper">
                <div class="field">
                    <label for="category" class="field-label">文章分类</label>
                    <select id="category" name="category_id" class="input">
                        <option value="">-- 无分类 --</option>
                    </select>
                </div>
                <button type="button" id="addCategoryBtn" class="button button-sm">新增</button>
            </div>
            
            <div class="field" style="margin-top: 16px;">
                <label for="chapters" class="field-label">章节</label>
                <textarea id="chapters" name="chapters" class="textarea" rows="4" placeholder="请输入文档章节，每行一个章节名称。这些将自动生成为二级标题 (##)。"></textarea>
            </div>
            <div class="field">
                <label for="content" class="field-label">文章内容 (支持 Markdown)</label>
                <textarea id="content" name="content"></textarea>
            </div>
            <div class="field">
                <button type="submit" class="button button-primary">保存文章</button>
            </div>
        </form>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <div id="categoryModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新分类</h5>
                    <button type="button" class="close-btn" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="field">
                            <label for="newCategoryName" class="field-label">分类名称</label>
                            <input type="text" id="newCategoryName" class="input" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button" data-dismiss="modal">取消</button>
                    <button type="button" id="saveCategoryBtn" class="button button-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('articleForm');
            const pageTitle = document.getElementById('page-title');
            const categorySelect = document.getElementById('category');
            const statusMessage = document.getElementById('statusMessage');
            const categoryModal = document.getElementById('categoryModal');
            const newCategoryNameInput = document.getElementById('newCategoryName');
            
            const accessToken = sessionStorage.getItem('adminAccessToken');
            if (!accessToken) {
                window.location.href = '/login.html';
                return;
            }

            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            };

            function selectAndUploadImage(editor) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = async () => {
                    if (!input.files || input.files.length === 0) return;
                    const file = input.files[0];
                    const cm = editor.codemirror;
                    
                    const placeholder = `![正在上传 ${file.name}...]()`;
                    cm.replaceSelection(placeholder);

                    const formData = new FormData();
                    formData.append('wiki_image', file);
                    try {
                        const response = await fetch('/api/admin/wiki/upload-image', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}` },
                            body: formData
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        
                        const newText = `![${file.name}](${result.imageUrl})`;
                        cm.setValue(cm.getValue().replace(placeholder, newText));

                    } catch (error) {
                        console.error("图片上传失败:", error);
                        cm.setValue(cm.getValue().replace(placeholder, `![上传失败: ${error.message}]()`));
                    }
                };
                
                input.click();
            }

            const simplemde = new SimpleMDE({
                element: document.getElementById("content"),
                spellChecker: false,
                toolbar: [
                    "bold", "italic", "heading", "|", 
                    "quote", "unordered-list", "ordered-list", "|", 
                    "link", 
                    {
                        name: "image",
                        action: selectAndUploadImage,
                        className: "fa fa-picture-o",
                        title: "上传图片",
                    },
                    "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                imageDrop: true,
                imagePaste: true,
                imageUploadFunction: async (file, onSuccess, onError) => {
                    const formData = new FormData();
                    formData.append('wiki_image', file);
                    try {
                        const response = await fetch('/api/admin/wiki/upload-image', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}` },
                            body: formData
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        onSuccess(result.imageUrl);
                    } catch (error) {
                        onError("图片上传失败: " + error.message);
                    }
                },
            });

            async function loadCategories() {
                try {
                    const catResponse = await fetch('/api/admin/wiki/categories', { headers });
                    const categories = await catResponse.json();
                    
                    const currentVal = categorySelect.value;
                    categorySelect.options.length = 1;

                    categories.forEach(cat => {
                        const option = new Option(cat.name, cat.id);
                        categorySelect.add(option);
                    });
                    
                    categorySelect.value = currentVal;

                } catch (error) {
                    console.error("加载分类失败:", error);
                }
            }

            await loadCategories();
            
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');

            if (articleId) {
                pageTitle.textContent = '编辑文章';
                try {
                    const response = await fetch(`/api/admin/wiki/articles/${articleId}`, { headers });
                    const article = await response.json();
                    
                    form.title.value = article.title;
                    form.slug.value = article.slug;
                    simplemde.value(article.content || '');
                    if (article.category_id) {
                        categorySelect.value = article.category_id;
                    }
                    if (article.chapters) {
                        form.chapters.value = article.chapters;
                    }

                } catch (error) {
                    statusMessage.textContent = '加载文章内容失败。';
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                statusMessage.textContent = '正在保存...';
                
                const body = {
                    title: form.title.value,
                    slug: form.slug.value,
                    content: simplemde.value(),
                    category_id: form.category_id.value || null,
                    chapters: form.chapters.value,
                };
                
                try {
                    const url = articleId ? `/api/admin/wiki/articles/${articleId}` : '/api/admin/wiki/articles';
                    const method = articleId ? 'PUT' : 'POST';

                    const response = await fetch(url, { method, headers, body: JSON.stringify(body) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);

                    statusMessage.textContent = '保存成功！';
                    statusMessage.className = 'status-message success-message';
                    
                    setTimeout(() => {
                        window.location.href = '/admin.html#wiki';
                    }, 1000);

                } catch (error) {
                    statusMessage.textContent = `保存失败: ${error.message}`;
                    statusMessage.className = 'status-message error-message';
                }
            });

            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                newCategoryNameInput.value = '';
                categoryModal.classList.add('show');
            });

            const closeModal = () => categoryModal.classList.remove('show');
            
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal || e.target.closest('[data-dismiss="modal"]')) {
                    closeModal();
                }
            });

            document.getElementById('saveCategoryBtn').addEventListener('click', async () => {
                const name = newCategoryNameInput.value.trim();
                if (!name) return alert('分类名称不能为空');
                
                const saveBtn = document.getElementById('saveCategoryBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = '保存中...';

                try {
                    const response = await fetch('/api/admin/wiki/categories', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ name })
                    });
                    
                    if (!response.ok) throw new Error('创建失败');
                    
                    const newCategory = await response.json();
                    
                    await loadCategories();

                    categorySelect.value = newCategory.id;

                    closeModal();
                } catch (error) {
                    alert(error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存';
                }
            });
        });
    </script>
</body>
</html>