<!DOCTYPE html>
<html lang="zh-CN" class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>提交工单 - TribitHub</title>
    
    <!-- 1. 链接到您的主样式表 -->
    <link rel="stylesheet" href="dist/css/style.css">
    
    <!-- 2. 内联脚本，用于在页面加载时立即应用主题 -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') {
                document.documentElement.classList.add('light-theme');
            }
        })();
    </script>

    <!-- 3. 针对此页面的专属样式 -->
    <style>
        .form-status {
            margin-top: 16px;
            font-weight: 600;
            font-size: 16px;
            min-height: 24px; /* 预留空间防止布局跳动 */
        }
        /* 成功和错误消息的颜色已在 style.css 中定义 */
    </style>
</head>
<body class="is-boxed has-animations">
    <div class="body-wrap">
        <header class="site-header">
            <div class="container">
                <div class="site-header-inner">
                    <div class="brand header-brand">
                        <h1 class="m-0">
                            <a href="index.html">
                                <span class="header-brand-text">TribitHub</span>
                            </a>
                        </h1>
                    </div>
                    <ul class="header-links list-reset">
                        <li><a href="index.html">首页</a></li>
                        <li><a href="pricing.html">我们的介绍</a></li>
                        <li><a href="contact.html">提交工单</a></li>
                        <!-- 这个链接会被 auth-ui.js 动态替换 -->
                        <li><a href="login-user.html">注册/登录</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <main>
            <section class="contact-section section">
                <div class="container">
                    <div class="section-inner">
                        <div class="section-header text-center">
                            <h2 class="section-title mt-0">提交新工单</h2>
                            <p class="section-paragraph">请详细描述您的需求，我们收到后会尽快处理。</p>
                        </div>
                        
                        <div class="contact-wrap">
                            <div class="contact-form" style="margin: 0 auto; max-width: 600px;">
                                <form id="contactForm">
                                    <!-- 称呼和邮箱输入框已被移除，因为我们会从登录状态自动获取 -->
                                    <div class="field">
                                        <label class="label screen-reader-text" for="subject">项目主题</label>
                                        <div class="control">
                                            <input id="subject" class="input" type="text" name="subject" placeholder="工单主题 (例如: '插件功能建议')" required>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label screen-reader-text" for="message">需求描述</label>
                                        <div class="control">
                                            <textarea id="message" class="textarea" name="message" placeholder="请在这里详细描述您的问题或需求..." rows="8" required></textarea>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button class="button button-primary button-block" type="submit">确认提交</button>
                                        </div>
                                    </div>
                                </form>
                                <div id="formStatus" class="form-status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="site-footer-minimal">
            <div class="container">
                <div class="footer-copyright">
                    &copy; 2025 TribitHub, 版权所有
                </div>
            </div>
        </footer>
    </div>
    
    <!-- 全局认证 UI 脚本，用于处理右上角的用户状态显示 -->
    <script src="dist/js/auth-ui.js" defer></script>

    <script>
        // =======================================================
        // contact.html - 最终、完整、未经省略的客户端脚本
        // 实现了需要登录才能提交工单的逻辑
        // =======================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- 步骤 1: 检查用户是否已登录 ---
            const sessionData = localStorage.getItem('supabase.auth.session');
            const form = document.getElementById('contactForm');
            const statusDiv = document.getElementById('formStatus');
            const submitButton = form.querySelector('button');

            if (!sessionData) {
                // 如果未登录，禁用表单，显示提示信息，并准备跳转
                form.style.display = 'none'; // 隐藏表单
                statusDiv.innerHTML = '请先 <a href="/login-user.html?redirect=/contact.html">登录</a> 后再提交工单。';
                statusDiv.className = 'status-message error-message'; // 使用错误样式
                return; // 终止后续脚本执行
            }

            // --- 步骤 2: 如果已登录，为表单绑定提交事件 ---
            const session = JSON.parse(sessionData);
            const accessToken = session.access_token;

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formData = new FormData(form);
                
                statusDiv.textContent = '正在提交...';
                statusDiv.className = 'status-message';
                submitButton.disabled = true;

                try {
                    // --- 步骤 3: 发送请求到受保护的 API 接口 ---
                    const response = await fetch('/api/tickets', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}` // 在请求头中附带用户的认证令牌
                        },
                        body: JSON.stringify({
                            subject: formData.get('subject'),
                            message: formData.get('message')
                        })
                    });

                    const result = await response.json();
                    
                    if (response.status === 401) {
                         // Token 可能已过期
                        localStorage.removeItem('supabase.auth.session');
                        throw new Error('您的登录已过期，请重新登录后再试。');
                    }
                    
                    if (!response.ok) {
                        throw new Error(result.error || '提交失败，请稍后重试');
                    }
                    
                    // --- 步骤 4: 处理成功响应 ---
                    statusDiv.textContent = '您的工单已成功提交！确认邮件已发送至您的邮箱。';
                    statusDiv.className = 'status-message success-message';
                    form.reset();

                } catch (error) {
                    // --- 步骤 5: 处理错误 ---
                    statusDiv.textContent = `提交失败: ${error.message}`;
                    statusDiv.className = 'status-message error-message';
                    // 如果是因为登录过期导致的失败，一段时间后可以自动跳转
                    if (error.message.includes('过期')) {
                        setTimeout(() => window.location.href = `/login-user.html?redirect=/contact.html`, 3000);
                    }
                } finally {
                    // 无论成功还是失败，最后都重新启用按钮
                    submitButton.disabled = false;
                }
            });
        });
    </script>
    
     <script src="dist/js/nav.js"></script>

</body>
</html>